# =============================================================================
# Odoo SaaS Platform - Prometheus Alert Rules
# =============================================================================

groups:
  # ===========================================================================
  # Service Availability Alerts
  # ===========================================================================
  - name: service_availability
    interval: 30s
    rules:
      - alert: AdminDashboardDown
        expr: up{job="admin-dashboard"} == 0
        for: 1m
        labels:
          severity: critical
          service: admin-dashboard
        annotations:
          summary: "Admin Dashboard is down"
          description: "The Admin Dashboard service has been unavailable for more than 1 minute."

      - alert: CustomerPortalDown
        expr: up{job="customer-portal"} == 0
        for: 1m
        labels:
          severity: critical
          service: customer-portal
        annotations:
          summary: "Customer Portal is down"
          description: "The Customer Portal service has been unavailable for more than 1 minute."

      - alert: PostgreSQLDown
        expr: up{job="postgres"} == 0
        for: 30s
        labels:
          severity: critical
          service: postgres
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL database server is unavailable. This is critical!"

      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 30s
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "Redis is down"
          description: "Redis cache server is unavailable. Sessions and job queues affected."

  # ===========================================================================
  # Performance Alerts
  # ===========================================================================
  - name: performance
    interval: 30s
    rules:
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(flask_http_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High API response time detected"
          description: "95th percentile response time is above 2 seconds for 5 minutes."

      - alert: HighErrorRate
        expr: |
          sum(rate(flask_http_request_total{status=~"5.."}[5m])) /
          sum(rate(flask_http_request_total[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "More than 5% of requests are returning 5xx errors."

      - alert: CriticalErrorRate
        expr: |
          sum(rate(flask_http_request_total{status=~"5.."}[5m])) /
          sum(rate(flask_http_request_total[5m])) > 0.10
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical error rate detected"
          description: "More than 10% of requests are returning 5xx errors."

  # ===========================================================================
  # Job Queue Alerts
  # ===========================================================================
  - name: job_queue
    interval: 30s
    rules:
      - alert: JobQueueBacklog
        expr: rq_jobs_in_queue > 100
        for: 10m
        labels:
          severity: warning
          service: worker
        annotations:
          summary: "Job queue backlog is growing"
          description: "More than 100 jobs are waiting in the queue for over 10 minutes."

      - alert: FailedJobsAccumulating
        expr: increase(rq_jobs_failed[1h]) > 10
        for: 5m
        labels:
          severity: warning
          service: worker
        annotations:
          summary: "Failed jobs accumulating"
          description: "More than 10 jobs have failed in the last hour."

      - alert: WorkerDown
        expr: rq_workers_count == 0
        for: 2m
        labels:
          severity: critical
          service: worker
        annotations:
          summary: "No RQ workers available"
          description: "All background workers are down. Job processing stopped."

  # ===========================================================================
  # Database Alerts
  # ===========================================================================
  - name: database
    interval: 30s
    rules:
      - alert: DatabaseConnectionsHigh
        expr: pg_stat_activity_count > 80
        for: 5m
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: "High database connection count"
          description: "PostgreSQL has more than 80 active connections."

      - alert: DatabaseConnectionsCritical
        expr: pg_stat_activity_count > 95
        for: 2m
        labels:
          severity: critical
          service: postgres
        annotations:
          summary: "Critical database connection count"
          description: "PostgreSQL is approaching max connections limit."

      - alert: SlowQueries
        expr: pg_stat_statements_seconds_total > 10
        for: 5m
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: "Slow database queries detected"
          description: "Some database queries are taking more than 10 seconds."

  # ===========================================================================
  # Memory and Resource Alerts
  # ===========================================================================
  - name: resources
    interval: 30s
    rules:
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes / 1024 / 1024 > 500
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Process memory usage is above 500MB for 10 minutes."

      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Redis memory usage high"
          description: "Redis is using more than 80% of available memory."
