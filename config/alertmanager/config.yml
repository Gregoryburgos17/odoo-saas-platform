# =============================================================================
# AlertManager Configuration
# =============================================================================
# Routes alerts to appropriate receivers based on severity and service

global:
  # Default SMTP settings (configure for your environment)
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@example.com'
  smtp_auth_username: ''
  smtp_auth_password: ''
  smtp_require_tls: true

  # Slack webhook (optional)
  slack_api_url: ''

# Alert routing tree
route:
  # Default receiver
  receiver: 'default-receiver'

  # Group alerts by these labels
  group_by: ['alertname', 'service', 'severity']

  # Wait before sending initial notification
  group_wait: 30s

  # Wait before sending updates to existing groups
  group_interval: 5m

  # Repeat interval for unresolved alerts
  repeat_interval: 4h

  # Child routes
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'critical-receiver'
      group_wait: 10s
      repeat_interval: 1h
      continue: true

    # Warning alerts - less urgent
    - match:
        severity: warning
      receiver: 'warning-receiver'
      group_wait: 5m
      repeat_interval: 4h

    # Database alerts - specific routing
    - match:
        service: postgres
      receiver: 'database-receiver'
      continue: true

# Inhibition rules to suppress notifications
inhibit_rules:
  # If service is down, suppress high response time alerts
  - source_match:
      alertname: 'AdminDashboardDown'
    target_match:
      service: 'admin-dashboard'
    equal: ['service']

  - source_match:
      alertname: 'CustomerPortalDown'
    target_match:
      service: 'customer-portal'
    equal: ['service']

  # PostgreSQL down inhibits all database alerts
  - source_match:
      alertname: 'PostgreSQLDown'
    target_match:
      service: 'postgres'
    equal: ['service']

# Receivers configuration
receivers:
  # Default receiver - logs to console in development
  - name: 'default-receiver'
    webhook_configs:
      - url: 'http://localhost:9999/webhook'  # Placeholder for development
        send_resolved: true

  # Critical alerts receiver
  - name: 'critical-receiver'
    # Email notification (configure SMTP above)
    # email_configs:
    #   - to: 'ops-critical@example.com'
    #     require_tls: true
    #     send_resolved: true

    # Slack notification (configure webhook above)
    # slack_configs:
    #   - channel: '#alerts-critical'
    #     send_resolved: true
    #     title: '{{ .Status | toUpper }} - {{ .CommonLabels.alertname }}'
    #     text: '{{ .CommonAnnotations.description }}'

    # Webhook for custom integrations
    webhook_configs:
      - url: 'http://localhost:9999/webhook/critical'
        send_resolved: true

  # Warning alerts receiver
  - name: 'warning-receiver'
    # slack_configs:
    #   - channel: '#alerts-warning'
    #     send_resolved: true
    webhook_configs:
      - url: 'http://localhost:9999/webhook/warning'
        send_resolved: true

  # Database-specific receiver
  - name: 'database-receiver'
    # email_configs:
    #   - to: 'dba@example.com'
    #     require_tls: true
    webhook_configs:
      - url: 'http://localhost:9999/webhook/database'
        send_resolved: true

# Templates for notification formatting
templates:
  - '/etc/alertmanager/templates/*.tmpl'
