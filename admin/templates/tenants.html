{% extends "base.html" %}

{% block title %}Tenants{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Tenants</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTenantModal">
        <i class="bi bi-plus-lg"></i> Create Tenant
    </button>
</div>

<!-- Search and Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <input type="text" class="form-control" id="search" placeholder="Search tenants...">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="state-filter">
                    <option value="">All States</option>
                    <option value="active">Active</option>
                    <option value="creating">Creating</option>
                    <option value="suspended">Suspended</option>
                    <option value="error">Error</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-secondary w-100" onclick="loadTenants()">
                    <i class="bi bi-search"></i> Search
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Tenants Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Tenant</th>
                        <th>Customer</th>
                        <th>State</th>
                        <th>Users</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tenants-tbody">
                    <tr>
                        <td colspan="6" class="text-center text-muted">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <nav id="pagination"></nav>
    </div>
</div>

<!-- Create Tenant Modal -->
<div class="modal fade" id="createTenantModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Tenant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="create-tenant-form">
                    <div class="mb-3">
                        <label class="form-label">Slug</label>
                        <input type="text" class="form-control" id="tenant-slug" required
                               pattern="[a-z][a-z0-9-]{2,48}[a-z0-9]"
                               placeholder="my-company">
                        <small class="text-muted">Lowercase letters, numbers, hyphens. 4-50 chars.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="tenant-name" required
                               placeholder="My Company Inc.">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Customer Email</label>
                        <input type="email" class="form-control" id="tenant-customer" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createTenant()">Create</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;

    async function loadTenants(page = 1) {
        currentPage = page;
        const search = document.getElementById('search').value;
        const state = document.getElementById('state-filter').value;

        let url = `/api/tenants?page=${page}&per_page=20`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        if (state) url += `&state=${state}`;

        const data = await apiCall(url);
        const tbody = document.getElementById('tenants-tbody');

        if (data.status === 'success') {
            const tenants = data.data.tenants;
            if (tenants.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No tenants found</td></tr>';
                return;
            }

            tbody.innerHTML = tenants.map(t => {
                const stateBadge = {
                    'active': 'bg-success',
                    'creating': 'bg-warning',
                    'suspended': 'bg-secondary',
                    'error': 'bg-danger',
                    'deleting': 'bg-danger'
                }[t.state] || 'bg-secondary';

                return `
                    <tr>
                        <td>
                            <strong>${t.name}</strong><br>
                            <small class="text-muted">${t.slug}</small>
                        </td>
                        <td>${t.customer_id.substring(0, 8)}...</td>
                        <td><span class="badge ${stateBadge}">${t.state}</span></td>
                        <td>${t.current_users}</td>
                        <td><small>${new Date(t.created_at).toLocaleDateString()}</small></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewTenant('${t.id}')">
                                    <i class="bi bi-eye"></i>
                                </button>
                                ${t.state === 'active' ? `
                                    <button class="btn btn-outline-warning" onclick="suspendTenant('${t.id}')">
                                        <i class="bi bi-pause"></i>
                                    </button>
                                ` : ''}
                                ${t.state === 'suspended' ? `
                                    <button class="btn btn-outline-success" onclick="resumeTenant('${t.id}')">
                                        <i class="bi bi-play"></i>
                                    </button>
                                ` : ''}
                                <button class="btn btn-outline-danger" onclick="deleteTenant('${t.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    }

    async function createTenant() {
        const slug = document.getElementById('tenant-slug').value;
        const name = document.getElementById('tenant-name').value;
        const customerEmail = document.getElementById('tenant-customer').value;

        // First find customer by email
        const customersData = await apiCall(`/api/customers?search=${encodeURIComponent(customerEmail)}`);
        if (customersData.status !== 'success' || customersData.data.customers.length === 0) {
            alert('Customer not found');
            return;
        }

        const customerId = customersData.data.customers[0].id;

        const response = await apiCall('/api/tenants', {
            method: 'POST',
            body: JSON.stringify({ slug, name, customer_id: customerId })
        });

        if (response.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('createTenantModal')).hide();
            loadTenants();
            alert('Tenant creation initiated');
        } else {
            alert(response.message || 'Failed to create tenant');
        }
    }

    async function suspendTenant(id) {
        if (!confirm('Suspend this tenant?')) return;
        const response = await apiCall(`/api/tenants/${id}/suspend`, { method: 'POST' });
        if (response.status === 'success') loadTenants();
        else alert(response.message);
    }

    async function resumeTenant(id) {
        const response = await apiCall(`/api/tenants/${id}/resume`, { method: 'POST' });
        if (response.status === 'success') loadTenants();
        else alert(response.message);
    }

    async function deleteTenant(id) {
        if (!confirm('Delete this tenant? This cannot be undone.')) return;
        const response = await apiCall(`/api/tenants/${id}`, { method: 'DELETE' });
        if (response.status === 'success') loadTenants();
        else alert(response.message);
    }

    function viewTenant(id) {
        window.location.href = `/tenants/${id}`;
    }

    document.addEventListener('DOMContentLoaded', loadTenants);
</script>
{% endblock %}
