{% extends "base.html" %}

{% block title %}Audit Logs{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Audit Logs</h2>
    <button class="btn btn-outline-secondary" onclick="loadLogs()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
</div>

<!-- Audit Logs Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Action</th>
                        <th>User</th>
                        <th>Resource</th>
                        <th>IP Address</th>
                    </tr>
                </thead>
                <tbody id="logs-tbody">
                    <tr>
                        <td colspan="5" class="text-center text-muted">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadLogs() {
        const data = await apiCall('/api/dashboard/recent-activity?limit=100');
        const tbody = document.getElementById('logs-tbody');

        if (data.status === 'success') {
            const logs = data.data.activities;
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No logs found</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(log => {
                const badge = {
                    'create': 'bg-success',
                    'update': 'bg-info',
                    'delete': 'bg-danger',
                    'login': 'bg-primary',
                    'logout': 'bg-secondary',
                    'suspend': 'bg-warning',
                    'resume': 'bg-success'
                }[log.action] || 'bg-secondary';

                return `
                    <tr>
                        <td><small>${new Date(log.created_at).toLocaleString()}</small></td>
                        <td><span class="badge ${badge}">${log.action}</span></td>
                        <td>${log.actor_email || 'System'}</td>
                        <td>${log.resource_type || '-'} ${log.resource_id ? log.resource_id.substring(0,8) : ''}</td>
                        <td><small class="text-muted">${log.ip_address || '-'}</small></td>
                    </tr>
                `;
            }).join('');
        }
    }

    document.addEventListener('DOMContentLoaded', loadLogs);
</script>
{% endblock %}
